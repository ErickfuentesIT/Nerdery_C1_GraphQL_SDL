# ---------------------------------------------------------
# 0. CUSTOM SCALARS
# ---------------------------------------------------------

"""A string representing a date and time in ISO-8601 format."""
scalar DateTime
"""A string representing a valid email address."""
scalar Email

# ---------------------------------------------------------
# 1. ENUMS
# ---------------------------------------------------------

"""Defines the authorization level of a user."""
enum Role {
  MANAGER
  CLIENT
}


"""The lifecycle stages of a customer order."""
enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  CANCELLED
  SHIPPED
  DELIVERED
}

"""Stripe status """
enum PaymentStatus {
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

# ---------------------------------------------------------
# 2. AUTH AND USER TYPES
# ---------------------------------------------------------

"""Represents a registered user in the system."""
type User {
  id: ID!
  username: String!
  email: Email!
  phoneNumber: String
  role: Role!
  isActive: Boolean!
  shippingAddresses: [ShippingAddress!]
  likes: [Like!]!
  orders: [Order!]!
  cartItems: [CartItem!]!
  createdAt: DateTime!
}

type AuthPayload {
  token: String!
  user: User!
}

type SignedUrlResponse {
  signedUrl: String!
  publicId: String!
  contentType: String!
}

# ---------------------------------------------------------
# 3. PRODUCT AND CATALOG CORE
# ---------------------------------------------------------

type Category {
  id: ID!
  name: String!
  products: [Product!]!
}

"""A physical product sold in the store."""
type Product {
  id: ID!
  name: String!
  description: String
  basePriceCents: Int!
  isActive: Boolean!
  category: Category!
  variants: [ProductVariant!]!
  likes: [Like!]!
  createdAt:  DateTime!
  updatedAt: DateTime!
}

"""A specific version of a product (e.g., Size: Large, Color: Blue)."""
type ProductVariant {
  id: ID!
  sku: String!
  stock: Int!
  priceCents: Int!
  isActive: Boolean!
  product: Product!
  images: [Image!]!
  variantAttributeCategories: [VariantAttributeCategory!]!
}

type Image {
  id: ID!
  imageUrl: String!
  variant: ProductVariant
}

# ---------------------------------------------------------
# 4. VARIANT ATTRIBUTES
# ---------------------------------------------------------

type Attribute {
  id: ID!
  name: String!
}

type AttributeCategory {
  id: ID!
  value: String!
  attribute: Attribute!
}

type VariantAttributeCategory {
  id: ID!
  variantId: ID!
  attributeCategoryId: ID!
  attributeCategory: AttributeCategory!
}

# ---------------------------------------------------------
# 5. COMMERCE: ORDERS, CART, AND LIKES
# ---------------------------------------------------------

type Order {
  id: ID!
  user: User!
  status: OrderStatus!
  totalAmountCents: Int!
  items: [OrderItem!]!
  payment: Payment
  createdAt: DateTime!
}

type OrderItem {
  id: ID!
  variant: ProductVariant!
  quantity: Int!
  priceAtPurchaseCents: Int!
}

type Payment {
  id: ID!
  order: Order!
  amount: Int!
  status: PaymentStatus!
  currency: String!
  createdAt: DateTime!
}

type CartItem {
  id: ID!
  user: User!
  variant: ProductVariant!
  quantity: Int!
}

type Like {
  id: ID!
  user: User!
  product: Product!
  createdAt:  DateTime!
}

type ShippingAddress {
  id: ID!
  street: String!
  city: String!
  state: String!
  country: String!
}

"""Response returned after attempting to initiate a Stripe checkout."""
type CheckoutSessionPayload {
  """The URL to redirect the user to Stripe's hosted checkout page."""
  checkoutUrl: String
  
  """The pending order created in our system, to be confirmed after payment."""
  order: Order
  
  """Indicates if the session was successfully created."""
  success: Boolean!
}

# ---------------------------------------------------------
# 6. RESPONSE PAGINATIONS
# ---------------------------------------------------------
"""Metadata for offset-based pagination."""
type PaginationMetadata {
  totalCount: Int!
}
"""Paginated list of products."""
type ProductsResponse {
  items: [Product!]!
  pagination: PaginationMetadata!
}

type CategoriesResponse {
  items: [Category!]!
  pagination: PaginationMetadata!
}

type OrdersResponse {
  items: [Order!]!
  pagination: PaginationMetadata!
}

type UsersResponse {
  items: [User!]!
  pagination: PaginationMetadata!
}

# ---------------------------------------------------------
# 7. QUERIES
# ---------------------------------------------------------

type Query {
  # Public Catalog
  """Fetch a list of active products with optional category filtering."""
  products(
    take: Int = 10, 
    skip: Int = 0, 
    categoryId: ID
  ): ProductsResponse!
  
  """Get detailed information for a single product by its ID."""
  product(id: ID!): Product
  
  categories(take: Int = 5, skip: Int = 0): CategoriesResponse!
  
  # Attributes
  attributes: [Attribute!]! 
  attributeCategories(attributeId: ID!): [AttributeCategory!]!
  
  # Client Only returns the order if it belongs to the logged-in user and Authorized
  """Retrieve the logged-in user's profile information."""
  userInformation: User
  """List of all orders placed by the current user."""
  myOrders(take: Int = 10, skip: Int = 0): OrdersResponse!
  """Fetch a specific order belonging to the logged-in user. Ownership is enforced."""
  order(id: ID!): Order
  myAddresses: [ShippingAddress!]! 
  
  # Manager
  allOrders(
    take: Int = 10, 
    skip: Int = 0, 
    status: OrderStatus, 
    userId: ID
  ): OrdersResponse!
  """View all users registered on the platform."""
  allUsers(take: Int = 10, skip: Int = 0): UsersResponse!
  
  userAddresses(userId: ID!): [ShippingAddress!]!
}

# ---------------------------------------------------------
# 7. MUTATIONS
# ---------------------------------------------------------

type Mutation {
  # Auth
  """Creates a new user account and returns an authentication token."""
  signUp(input: SignUpInput!): AuthPayload!
  signIn(input: SignInInput!): AuthPayload!
  """Terminates the current session. Returns a confirmation message."""
  signOut: String!  #(g., "Successfully signed out")
  forgotPassword(email: String!): String! # (e.g., "If an account exists for this email, a reset link has been sent.")
  resetPassword(input: ResetPasswordInput!): AuthPayload! # Returning AuthPayload allows immediate login after reset

  # Manager: Product Management
  """Create a main product listing."""
  createProduct(input: CreateProductInput!): Product!
  updateProduct(id: ID!, input: UpdateProductInput!): Product!
  deleteProduct(id: ID!): Product! 

  # Variants
  createProductVariant(input: CreateVariantInput!): ProductVariant!
  """Update details for a specific variant (stock, price, SKU)."""
  updateProductVariant(id: ID!, input: UpdateVariantInput!): ProductVariant!
  """Permanently remove a variant from the catalog."""
  deleteProductVariant(id: ID!): ProductVariant!

  # Manager: Attribute Management
  createAttribute(name: String!): Attribute!
  updateAttribute(id: ID!, name: String!): Attribute!
  deleteAttribute(id: ID!): Attribute!
  createAttributeCategory(input: CreateAttributeCategoryInput!): AttributeCategory!
  updateAttributeCategory(id: ID!, value: String!): AttributeCategory!
  deleteAttributeCategory(id: ID!): AttributeCategory!

  # Manager: Media Management
  """Generates a temporary URL to upload a file directly to storage."""
  generateUploadUrl(filename: String!): SignedUrlResponse!
  insertProductImage(variantId: ID!, publicId: String!): Image!
  deleteProductImage(id: ID!): Image!

  # Client: Engagement And Checkout
  toggleLike(productId: ID!): Like # Can be null if the like was removed
  createCheckoutSession: CheckoutSessionPayload!

  # Client: Cart Management
  addToCart(variantId: ID!, quantity: Int!): CartItem!
  updateCartItemQuantity(id: ID!, quantity: Int!): CartItem!
  removeFromCart(id: ID!): CartItem! # Return the item that was removed

  # Client: Address Management
  createAddress(input: CreateAddressInput!): ShippingAddress!
  updateAddress(id: ID!, input: UpdateAddressInput!): ShippingAddress!
  deleteAddress(id: ID!): ShippingAddress!
}

# ---------------------------------------------------------
# 8. INPUTS
# ---------------------------------------------------------

input SignUpInput {
  username: String!
  email:  Email!
  password: String!
}

input SignInInput {
  email: Email!
  password: String!
}

input ResetPasswordInput {
  token: String!
  newPassword: String!
}

input CreateProductInput {
  name: String!
  description: String
  basePrice: Int!
  categoryId: ID!
  variants: [CreateVariantInput!]!
}

input CreateVariantInput {
  sku: String!
  stock: Int!
  priceCents: Int!
  attributeValueIds: [ID!]!
}

input UpdateProductInput {
  name: String
  description: String
  basePrice: Int
  isActive: Boolean
  categoryId: ID
}

input CreateAttributeCategoryInput {
  attributeId: ID!
  value: String!
}

input CreateAddressInput {
  street: String!
  city: String!
  state: String!
  country: String!
}

input UpdateAddressInput {
  street: String
  city: String
  state: String
  country: String
}

input UpdateVariantInput {
  sku: String
  stock: Int
  priceCents: Int
  isActive: Boolean
  attributeValueIds: [ID!]!
}

# ---------------------------------------------------------
# 9. SCHEMA DEFINITION
# ---------------------------------------------------------

schema {
  query: Query
  mutation: Mutation
}
